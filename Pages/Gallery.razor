@page "/gallery"
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Image Gallery</PageTitle>

<!-- Title, SearchBar and the Search Button -->
<div style="display:flex;">
    <h1 class="white" style="margin-right:20px; width:fit-content; white-space: nowrap;">Image Gallery</h1>
    <input @bind="query" @bind:event="oninput" @onkeydown="HandleKeyPress" type="text" placeholder="Search...">
    <button @onclick="Search" type="button"><span class="oi oi-magnifying-glass" aria-hidden="true"></span></button>
</div>

<!-- Displaying a loading message while the data is being requested from the API -->
@if (isLoading)
{
    <p class="white">Loading...</p>
}
//Displaying a no results message if the API returned with no results
else if (results == null || results.Count == 0)
{
    <p class="white">No results.</p>
}
//Displaying the images and associated information provided by the API
else
{
    <div class="imageCardContainer">

        @foreach (var item in results)
        {
            <div class="imageCard" @onclick="() => OpenImage(item)">
                <img src="@item.ImageUrl"
                     alt="@item.Title"
                     style="width:100%; height:180px; object-fit:cover;" />
                <div style="padding:10px;">
                    <p style="margin:0; font-size:14px; opacity:0.7; color:white;">
                        @item.Date
                    </p>
                    <h3 class="imageCardTitle">@item.Title</h3>
                </div>
            </div>
        }
        <!-- Displaying a focused version of the image with extra information when clicked -->
        @if (selectedItem != null)
        {
            <div class="modal-overlay" @onclick="CloseImage">
                <div class="modal-content" @onclick:stopPropagation="true">

                    <img src="@selectedItem.ImageUrl"
                        style="width:100%; object-fit:contain; max-height:60vh; margin-bottom:20px;" />

                    <h2>@selectedItem.Title</h2>
                    <p><strong>Date:</strong> @selectedItem.Date</p>
                    <p>@selectedItem.Description</p>

                    <button style="border-radius: 5px; border:2px solid transparent;" @onclick="CloseImage">Close</button>
                </div>
            </div>
        }
    </div>
}

@code {
    //Class to store the Image information
    public class ImageCard
    {
        public string? Title { get; set; }
        public string? Date { get; set; }
        public string? ImageUrl { get; set; }
        public string? Description { get; set; }
    }

    string query = "";
    bool isLoading = false;
    List<ImageCard> results = new();

    //Trigger a search with an empty query on page load
    protected override async Task OnInitializedAsync()
    {
        await Search();
    }

    //Trigger search on Enter press
    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Search();
        }
    }

    //Search function to request images (filtered by the provided query) from the API. (no API key requred for this one)
    private async Task Search()
    {
        //Clear previous results
        results.Clear();

        //Exit with no results if query is null
        if (query == null)
        {
            return;
        }

        isLoading = true;

        try
        {
            // Making an API request with the query and storing the results
            var url = $"https://images-api.nasa.gov/search?q={query}&media_type=image";
            NasaSearchRoot? root = await Http.GetFromJsonAsync<NasaSearchRoot>(url);
            var items = root?.collection?.items ?? new List<Item>();

            // Creating an image card foreach returned image result 
            foreach (var item in items)
            {
                var data = item.data?.FirstOrDefault();
                var link = item.links?.FirstOrDefault();

                if (data == null || link == null)
                    continue;

                results.Add(new ImageCard
                {
                    Title = data.title,
                    Date = data.date_created?.Split("T")[0] ?? "",
                    ImageUrl = link.href,
                    Description = data.description
                });
            }
        }
        //Catching API request exceptions
        catch (Exception ex)
        {
            Console.WriteLine("NASA Error: " + ex.Message);
        }

        isLoading = false;

        
    }
    ImageCard? selectedItem;

    //Functions to focus and unfocus Images
    void OpenImage(ImageCard item)
    {
        JS.InvokeVoidAsync("disableScroll");
        selectedItem = item;
    }
    void CloseImage()
    {
        JS.InvokeVoidAsync("enableScroll");
        selectedItem = null;
    }

    //Helper classes for processing the image data
    public class NasaSearchRoot
    {
        public Collection? collection { get; set; }
    }

    public class Collection
    {
        public List<Item>? items { get; set; }
    }

    public class Item
    {
        public List<DataElement>? data { get; set; }
        public List<Link>? links { get; set; }
    }

    public class DataElement
    {
        public string? title { get; set; }
        public string? date_created { get; set; }
        public string? description { get; set; }
    }

    public class Link
    {
        public string? href { get; set; }
    }
}